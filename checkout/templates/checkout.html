{% extends "base.html" %}
{% load static from staticfiles %}
{% load bootstrap_tags %}
{% load mathfilters %}

{% block head_js %}
    <script type="text/javascript" src="https://js.stripe.com/v2/"></script>
    <script type="text/javascript">
        //<![CDATA[
            Stripe.publishableKey = '{{ publishable }}';
        //]]>
    </script>
    <script type="text/javascript" src="{% static 'js/stripe.js' %}"></script>
{% endblock head_js %}

{% block content %}
{% if not cart_items %}
    <p>You don't have any items in your cart.</p>
{% else %}
    <p class="product-pitch">Please review your order and enter your payment details if everything is correct.</p>
    <div class="row row-flex">
        {% for item in cart_items %}
            <div class="col-xs-10 col-xs-offset-1 col-sm-offset-0 col-sm-6 col-md-4 display panel panel-default">
                <div class="panel-body">
                    {% if item.product.image_path %}
                        <div><img class="product-image" src="{{ item.product.image_path }}" alt="{{ item.product.image_caption }}"></div>
                    {% else %}
                        <div class="product-image" style="background-image: url('{{ MEDIA_URL }}{{ item.product.image }}')"></div>
                    {% endif %}
                    <div class="caption">
                        <h3 class="item-product-name">{{ item.product.name }}</h3>
                        <p>{{ item.product.description }}</p>
                        <h4 class="product-pitch">Price: {{ item.quantity }} x £{{ item.product.price }} = £{{ item.quantity|mul:item.product.price }}</h4>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% endif %}
    <div>
        {% if total != 0 %}
            <h4 class="checkout-total">Cart subtotal: £{{ subtotal }}</h4>
            {% if discount_amount != 0 %}
                <h4 class="checkout-total">Discount @{{ percent }}% : £{{ discount_amount }}</h4>
            {% else %}
                <h4 class="checkout-total">Single item purchase - no discount applied.</h4>
            {% endif %}
            <h3 class="checkout-total">Total to pay: £{{ total }}</h3>
            <a href="{% url 'empty_cart' %}" class="btn btn-custom" role="button">
                <span class="glyphicon glyphicon-remove-circle" aria-hidden="true"></span> Empty Cart</a>
        {% else %}
            <a href="{% url 'all_products' %}" class="btn btn-custom" role="button">
                <span class="glyphicon glyphicon-gift" aria-hidden="true"></span> Continue Shopping</a>
        {% endif %}
    </div>

{% if cart_items %}
    <form method="POST" role="form" id="payment-form" action="{% url 'checkout' %}">
        <h3 class="checkout-total">Payment Details</h3>

        <div id="credit-card-errors" style="display: none;">
            <div class="alert-message block-message error" id="stripe-error-message"></div>
        </div>

        {% csrf_token %}
        <div class="form-group col-md-6">
            {{ order_form | as_bootstrap }}
        </div>

        <div class="form-group col-md-6">
            {{ payment_form | as_bootstrap }}
        </div>

        <div class="col-md-12">
            <!--
            Inline style applied below to overcome problem of text colour appearing black after clicking
            and returning to this page. Refreshing page or clicking elsewhere returns the text colour to
            white again. Can't find solution on forums.
            -->
            <button type="submit" id="submit_payment_btn" name="commit" class="btn btn-custom" style="color:white;">
                <span class="glyphicon glyphicon-ok"></span> Pay Now</button>
        </div>
    </form>
{% endif %}
{% endblock %}